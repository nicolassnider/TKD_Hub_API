name: Deploy WebAPI to Azure App Service




# This workflow builds and deploys the ASP.NET Core WebAPI to Azure App Service
# Triggers on changes to the WebAPI source code in src/TKDHubAPI.* folders




on:
  push:
    branches:
      - master
    paths:
      - 'src/TKDHubAPI.WebAPI/**'
      - 'src/TKDHubAPI.Application/**'
      - 'src/TKDHubAPI.Domain/**'
      - 'src/TKDHubAPI.Infrastructure/**'
      - 'src/TKDHubAPI.Core/**'
  workflow_dispatch: # Allow manual trigger




env:
  AZURE_WEBAPP_NAME: 'tkd-hub-api-349491'  # Update this to match your WebAPI name from quick-deploy.ps1
  AZURE_WEBAPP_PACKAGE_PATH: './src/TKDHubAPI.WebAPI'
  DOTNET_VERSION: '8.0.x'




jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
   
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4




      - name: Setup .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}




      - name: Restore dependencies
        run: dotnet restore ./src/TKDHubAPI.WebAPI/TKDHubAPI.WebAPI.csproj




      - name: Build application
        run: dotnet build ./src/TKDHubAPI.WebAPI/TKDHubAPI.WebAPI.csproj --configuration Release --no-restore




      - name: Run tests
        run: |
          # Run unit tests before deployment
          dotnet test ./tests/TKDHubAPI.Application.Test/TKDHubAPI.Application.Test.csproj \
            --configuration Release --no-build --verbosity normal \
            --logger "console;verbosity=normal"




      - name: Publish application
        run: dotnet publish ./src/TKDHubAPI.WebAPI/TKDHubAPI.WebAPI.csproj --configuration Release --no-build --output ./publish




      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./publish




      - name: Deployment Summary
        run: |
          echo "üöÄ WebAPI Deployment Complete!"
          echo "üìç App Service: ${{ env.AZURE_WEBAPP_NAME }}"
          echo "üåê URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          echo "üîç Health Check: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health"
          echo "üìö Swagger: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/swagger"